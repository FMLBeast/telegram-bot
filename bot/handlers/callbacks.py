"""Clean callback query handlers for inline keyboards."""

from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import ContextTypes

from ..core.logging import get_logger
from ..services.openai_service import OpenAIService
from ..services.user_service import UserService

logger = get_logger(__name__)
openai_service = OpenAIService()
user_service = UserService()


async def callback_handler(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """Handle callback queries from inline keyboards."""
    if not update.callback_query or not update.effective_user:
        return
    
    query = update.callback_query
    await query.answer()  # Answer the callback query
    
    user = update.effective_user
    callback_data = query.data
    
    logger.info("Callback received", user_id=user.id, callback_data=callback_data)
    
    try:
        if callback_data == "start":
            await show_main_menu(query, context)
        elif callback_data == "help":
            await show_help_menu(query, context)
        elif callback_data == "ai_menu":
            await show_ai_menu(query, context)
        elif callback_data == "crypto_menu":
            await show_crypto_menu(query, context)
        elif callback_data == "todo_menu":
            await show_todo_menu(query, context)
        elif callback_data == "calc_menu":
            await show_calc_menu(query, context)
        elif callback_data == "nsfw_menu":
            await show_nsfw_menu(query, context)
        elif callback_data == "voting_menu":
            await show_voting_menu(query, context)
        elif callback_data == "stats_menu":
            await show_stats_menu(query, context)
        else:
            await query.edit_message_text("‚ùå Unknown command. Use /start to go back to the main menu.")
            
    except Exception as e:
        logger.error("Callback error", callback_data=callback_data, error=str(e), exc_info=True)
        try:
            await query.edit_message_text("‚ùå An error occurred. Use /start to go back to the main menu.")
        except Exception:
            pass


async def show_main_menu(query, context: ContextTypes.DEFAULT_TYPE) -> None:
    """Show the main menu."""
    user = query.from_user
    
    text = (
        f"ü§ñ **Welcome {user.first_name or user.username}!**\n\n"
        "Choose what you'd like to do:\n\n"
        "üß† **AI Chat & Images** - Chat with AI, generate images\n"
        "üí∞ **Crypto Tools** - Live prices, trading tools\n"
        "üìù **Todo Management** - Organize your tasks\n"
        "üé≤ **Calculators** - Mines & B2B betting tools\n"
        "üîû **NSFW Content** - Adult content (18+)\n"
        "üó≥Ô∏è **Polls & Voting** - Create and participate in polls\n"
        "üìä **Statistics** - Your activity stats\n"
    )
    
    keyboard = [
        [
            InlineKeyboardButton("üß† AI & Images", callback_data="ai_menu"),
            InlineKeyboardButton("üí∞ Crypto Tools", callback_data="crypto_menu"),
        ],
        [
            InlineKeyboardButton("üìù Todo List", callback_data="todo_menu"),
            InlineKeyboardButton("üé≤ Calculators", callback_data="calc_menu"),
        ],
        [
            InlineKeyboardButton("üîû NSFW (18+)", callback_data="nsfw_menu"),
            InlineKeyboardButton("üó≥Ô∏è Polls", callback_data="voting_menu"),
        ],
        [
            InlineKeyboardButton("üìä Statistics", callback_data="stats_menu"),
            InlineKeyboardButton("üÜò Help", callback_data="help"),
        ],
    ]
    
    await query.edit_message_text(
        text,
        reply_markup=InlineKeyboardMarkup(keyboard),
        parse_mode="Markdown"
    )


async def show_help_menu(query, context: ContextTypes.DEFAULT_TYPE) -> None:
    """Show help menu."""
    text = (
        "üÜò **Help & Commands**\n\n"
        "**Basic Commands:**\n"
        "‚Ä¢ `/start` - Main menu\n"
        "‚Ä¢ `/menu` - Show menu\n"
        "‚Ä¢ `/help` - Show help\n\n"
        "**AI Commands:**\n"
        "‚Ä¢ `/ask [question]` - Ask AI anything\n"
        "‚Ä¢ `/draw_me [prompt]` - Generate image\n\n"
        "**Crypto Commands:**\n"
        "‚Ä¢ `/price [symbol]` - Get crypto price\n"
        "‚Ä¢ `/convert [amount] [from] [to]` - Convert currency\n\n"
        "**Todo Commands:**\n"
        "‚Ä¢ `/add_todo [task]` - Add task\n"
        "‚Ä¢ `/list_todos` - Show tasks\n\n"
        "**Calculator Commands:**\n"
        "‚Ä¢ `/mines [mines] [diamonds]` - Mines calculator\n"
        "‚Ä¢ `/b2b [base] [multiplier] [increase%]` - B2B calculator\n\n"
        "**NSFW Commands (18+):**\n"
        "‚Ä¢ `/random_boobs` - Random content\n"
        "‚Ä¢ `/gimme [type]` - Specific content\n\n"
        "**Poll Commands:**\n"
        "‚Ä¢ `/poll \"Question\" \"Option1\" \"Option2\"` - Create poll\n"
        "‚Ä¢ `/polls` - List active polls\n\n"
        "üí° *Use the menu buttons for easier access!*"
    )
    
    keyboard = [
        [InlineKeyboardButton("üè† Back to Main Menu", callback_data="start")]
    ]
    
    await query.edit_message_text(
        text,
        reply_markup=InlineKeyboardMarkup(keyboard),
        parse_mode="Markdown"
    )


async def show_ai_menu(query, context: ContextTypes.DEFAULT_TYPE) -> None:
    """Show AI menu."""
    text = (
        "üß† **AI Chat & Image Generation**\n\n"
        "**Available Features:**\n"
        "‚Ä¢ AI conversation with GPT-4\n"
        "‚Ä¢ AI image generation with DALL-E\n"
        "‚Ä¢ Multiple image creation\n\n"
        "**How to Use:**\n"
        "‚Ä¢ Use `/ask [question]` for AI chat\n"
        "‚Ä¢ Use `/draw_me [prompt]` for images\n"
        "‚Ä¢ Use `/draw_multiple [prompt]` for multiple images\n\n"
        "üí° *Just type your question or image prompt!*"
    )
    
    keyboard = [
        [InlineKeyboardButton("üè† Back to Main Menu", callback_data="start")]
    ]
    
    await query.edit_message_text(
        text,
        reply_markup=InlineKeyboardMarkup(keyboard),
        parse_mode="Markdown"
    )


async def show_crypto_menu(query, context: ContextTypes.DEFAULT_TYPE) -> None:
    """Show crypto menu."""
    text = (
        "üí∞ **Crypto Tools**\n\n"
        "**Available Features:**\n"
        "‚Ä¢ Live cryptocurrency prices\n"
        "‚Ä¢ Currency converter\n"
        "‚Ä¢ Virtual crypto betting\n"
        "‚Ä¢ Trading balance tracking\n\n"
        "**How to Use:**\n"
        "‚Ä¢ Use `/price [symbol]` for current prices\n"
        "‚Ä¢ Use `/convert [amount] [from] [to]` for conversion\n"
        "‚Ä¢ Use `/bet [symbol] [up/down] [amount]` for betting\n"
        "‚Ä¢ Use `/balance` to check your virtual balance\n\n"
        "üí° *All trading is virtual - no real money involved!*"
    )
    
    keyboard = [
        [InlineKeyboardButton("üè† Back to Main Menu", callback_data="start")]
    ]
    
    await query.edit_message_text(
        text,
        reply_markup=InlineKeyboardMarkup(keyboard),
        parse_mode="Markdown"
    )


async def show_todo_menu(query, context: ContextTypes.DEFAULT_TYPE) -> None:
    """Show todo menu."""
    text = (
        "üìù **Todo Management**\n\n"
        "**Available Features:**\n"
        "‚Ä¢ Create and organize todo lists\n"
        "‚Ä¢ Add tasks with priorities\n"
        "‚Ä¢ Mark tasks as complete\n"
        "‚Ä¢ Track productivity statistics\n\n"
        "**How to Use:**\n"
        "‚Ä¢ Use `/add_todo [task]` to add tasks\n"
        "‚Ä¢ Use `/list_todos` to see your tasks\n"
        "‚Ä¢ Use `/complete_todo [id]` to mark complete\n"
        "‚Ä¢ Use `/todo_stats` for statistics\n\n"
        "üí° *Stay organized and productive!*"
    )
    
    keyboard = [
        [InlineKeyboardButton("üè† Back to Main Menu", callback_data="start")]
    ]
    
    await query.edit_message_text(
        text,
        reply_markup=InlineKeyboardMarkup(keyboard),
        parse_mode="Markdown"
    )


async def show_calc_menu(query, context: ContextTypes.DEFAULT_TYPE) -> None:
    """Show calculator menu."""
    text = (
        "üé≤ **Game Calculators**\n\n"
        "**Available Calculators:**\n"
        "‚Ä¢ Mines game calculator\n"
        "‚Ä¢ B2B betting progression calculator\n\n"
        "**How to Use:**\n"
        "‚Ä¢ Use `/mines [mines] [diamonds]` for odds calculation\n"
        "‚Ä¢ Use `/mines [multiplier]` to find best combinations\n"
        "‚Ä¢ Use `/b2b [base] [multiplier] [increase%]` for betting progression\n\n"
        "**Examples:**\n"
        "‚Ä¢ `/mines 5 3` - Calculate odds for 5 mines, 3 diamonds\n"
        "‚Ä¢ `/b2b 100 2.0 10` - Base bet 100, 2x multiplier, 10% increase\n\n"
        "üí° *Mathematical precision for gaming!*"
    )
    
    keyboard = [
        [InlineKeyboardButton("üè† Back to Main Menu", callback_data="start")]
    ]
    
    await query.edit_message_text(
        text,
        reply_markup=InlineKeyboardMarkup(keyboard),
        parse_mode="Markdown"
    )


async def show_nsfw_menu(query, context: ContextTypes.DEFAULT_TYPE) -> None:
    """Show NSFW menu."""
    text = (
        "üîû **NSFW Adult Content (18+)**\n\n"
        "‚ö†Ô∏è **Adults Only - 18+ Required** ‚ö†Ô∏è\n\n"
        "**Available Features:**\n"
        "‚Ä¢ Random adult images\n"
        "‚Ä¢ Random adult videos\n"
        "‚Ä¢ Content search by category\n"
        "‚Ä¢ Performer information lookup\n\n"
        "**How to Use:**\n"
        "‚Ä¢ Use `/random_boobs` for random images\n"
        "‚Ä¢ Use `/random_video` for random videos\n"
        "‚Ä¢ Use `/gimme [type]` for specific content\n"
        "‚Ä¢ Use `/show_me [name]` for performer info\n\n"
        "‚ö†Ô∏è *This content is for adults only!*"
    )
    
    keyboard = [
        [InlineKeyboardButton("üè† Back to Main Menu", callback_data="start")]
    ]
    
    await query.edit_message_text(
        text,
        reply_markup=InlineKeyboardMarkup(keyboard),
        parse_mode="Markdown"
    )


async def show_voting_menu(query, context: ContextTypes.DEFAULT_TYPE) -> None:
    """Show voting menu."""
    text = (
        "üó≥Ô∏è **Polls & Voting System**\n\n"
        "**Available Features:**\n"
        "‚Ä¢ Create custom polls\n"
        "‚Ä¢ Multiple choice voting\n"
        "‚Ä¢ Real-time results\n"
        "‚Ä¢ Anonymous voting options\n\n"
        "**How to Use:**\n"
        "‚Ä¢ Use `/poll \"Question\" \"Option1\" \"Option2\"` to create polls\n"
        "‚Ä¢ Use `/polls` to list active polls\n"
        "‚Ä¢ Use `/vote [poll_id] [option]` to cast votes\n\n"
        "**Examples:**\n"
        "‚Ä¢ `/poll \"Best pizza?\" \"Margherita\" \"Pepperoni\" \"Hawaiian\"`\n\n"
        "üí° *Full democracy in your chats!*"
    )
    
    keyboard = [
        [InlineKeyboardButton("üè† Back to Main Menu", callback_data="start")]
    ]
    
    await query.edit_message_text(
        text,
        reply_markup=InlineKeyboardMarkup(keyboard),
        parse_mode="Markdown"
    )


async def show_stats_menu(query, context: ContextTypes.DEFAULT_TYPE) -> None:
    """Show statistics menu."""
    user = query.from_user
    
    text = (
        f"üìä **Statistics Dashboard**\n\n"
        f"**Your Info:**\n"
        f"‚Ä¢ User: {user.first_name or user.username}\n"
        f"‚Ä¢ ID: {user.id}\n\n"
        f"**Available Stats:**\n"
        f"‚Ä¢ Personal activity statistics\n"
        f"‚Ä¢ Command usage analytics\n"
        f"‚Ä¢ Bot performance metrics\n"
        f"‚Ä¢ Feature usage tracking\n\n"
        f"**How to Use:**\n"
        f"‚Ä¢ Use `/my_activity` for your stats\n"
        f"‚Ä¢ Use `/most_active_users` for leaderboards\n"
        f"‚Ä¢ Use `/night_owls` for activity patterns\n\n"
        f"üí° *Data-driven insights for optimization!*"
    )
    
    keyboard = [
        [InlineKeyboardButton("üè† Back to Main Menu", callback_data="start")]
    ]
    
    await query.edit_message_text(
        text,
        reply_markup=InlineKeyboardMarkup(keyboard),
        parse_mode="Markdown"
    )